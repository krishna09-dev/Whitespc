@page "/"
@implements IDisposable
@inject JournalService JournalService
@inject TagService TagService
@inject AnalyticsService AnalyticsService
@inject SecurityService SecurityService
@inject MotivationService MotivationService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager




<div class="space-y-6 page-enter">
@if (!IsEditing)
{
    <!-- Statistics Section -->
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5 animate-fade-in-up hover-lift">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Statistics</h3>
        </div>
        <div class="grid grid-cols-3 gap-4">
            <div class="text-center p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg transition-transform hover:scale-105 animate-fade-in-up stagger-1">
                <p class="text-3xl font-bold text-orange-600 dark:text-orange-400">@StreakInfo.CurrentStreak</p>
                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Current Streak 🔥</p>
            </div>
            <div class="text-center p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg transition-transform hover:scale-105 animate-fade-in-up stagger-2">
                <p class="text-3xl font-bold text-purple-600 dark:text-purple-400">@StreakInfo.LongestStreak</p>
                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Longest Streak 🏆</p>
            </div>
            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg transition-transform hover:scale-105 animate-fade-in-up stagger-3">
                <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">@StreakInfo.TotalEntries</p>
                <p class="text-xs text-slate-600 dark:text-slate-400 mt-1">Total Entries 📝</p>
            </div>
        </div>
    </div>

    <!-- Daily Motivation Section -->
    @if (ShowDailyMotivation && !string.IsNullOrEmpty(DailyQuote))
    {
        <div class="bg-gradient-to-r from-primary-50 to-primary-100 dark:from-primary-900/20 dark:to-primary-800/20 rounded-xl shadow-sm border border-primary-200 dark:border-primary-700/30 p-4 animate-fade-in-up stagger-2 hover-lift">
            <div class="flex items-start gap-3">
                <span class="text-2xl animate-bounce-subtle">💡</span>
                <div>
                    <p class="text-sm font-medium text-primary-800 dark:text-primary-200">Daily Motivation</p>
                    <p class="text-sm text-primary-700 dark:text-primary-300 italic leading-relaxed mt-1">"@DailyQuote"</p>
                </div>
            </div>
        </div>
    }

    <!-- Today's Journal Section -->
    <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-5 animate-fade-in-up stagger-3">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Today's Journal</h3>
            </div>
            @if (!TodayEntries.Any())
            {
                <button @onclick="StartNewEntry" class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-all flex items-center gap-2 text-sm font-medium btn-press ripple hover:scale-105">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    New Entry
                </button>
            }
            else
            {
                <button @onclick="() => EditEntry(TodayEntries.First())" class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-all flex items-center gap-2 text-sm font-medium btn-press ripple hover:scale-105">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit Entry
                </button>
            }
        </div>

        @if (IsLoading)
        {
            <div class="flex items-center justify-center py-12">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
            </div>
        }
        else if (TodayEntries.Any())
        {
            <!-- Display Today's Entry -->
            <div class="space-y-3">
                @foreach (var entry in TodayEntries)
                {
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg p-4 hover:border-primary-300 dark:hover:border-primary-700 transition-all card-interactive animate-fade-in-up">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2 flex-1">
                                <span class="text-lg">@entry.PrimaryMood.GetEmoji()</span>
                                <h4 class="font-medium text-slate-800 dark:text-slate-100">@entry.Title</h4>
                                @if (entry.IsFavorite)
                                {
                                    <svg class="w-4 h-4 text-amber-500 animate-scale-in" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                    </svg>
                                }
                            </div>
                            <div class="flex items-center gap-1">
                                <button @onclick="() => ViewEntry(entry)" title="View" class="p-1.5 text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded transition-all hover:scale-110 btn-press">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                    </svg>
                                </button>
                                <button @onclick="() => EditEntry(entry)" title="Edit" class="p-1.5 text-slate-400 hover:text-primary-600 dark:hover:text-primary-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded transition-all hover:scale-110 btn-press">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button @onclick="() => ToggleFavoriteEntry(entry)" title="@(entry.IsFavorite ? "Remove from favorites" : "Add to favorites")" class="p-1.5 @(entry.IsFavorite ? "text-amber-500" : "text-slate-400 hover:text-amber-500") hover:bg-slate-100 dark:hover:bg-slate-700 rounded transition-all hover:scale-110 btn-press">
                                    <svg class="w-4 h-4" fill="@(entry.IsFavorite ? "currentColor" : "none")" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                    </svg>
                                </button>
                                <button @onclick="() => ConfirmDeleteEntry(entry)" title="Delete" class="p-1.5 text-slate-400 hover:text-red-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded transition-all hover:scale-110 btn-press">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2 prose prose-sm prose-slate dark:prose-invert max-w-none">
                            @((MarkupString)GetPreviewText(entry.Content))
                        </div>
                        <p class="text-xs text-slate-400 mt-2">@entry.CreatedAt.ToString("h:mm tt")</p>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Empty State -->
            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
                <p class="text-sm mb-3">No journal entries for today</p>
                <button @onclick="StartNewEntry" class="text-primary-600 dark:text-primary-400 hover:underline text-sm font-medium">
                    Write your first entry →
                </button>
            </div>
        }
    </div>
}
else if (IsEditing)
{
    <!-- Entry Editor -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 animate-slide-up">
            <!-- Back Button Header -->
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-200 dark:border-slate-700">
                <button @onclick="CancelEditing" class="flex items-center gap-2 text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    <span class="font-medium">Back</span>
                </button>
                <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100">
                    @(CurrentEntry != null ? "Edit Entry" : "New Journal Entry")
                </h3>
                <div class="w-16"></div> <!-- Spacer for centering -->
            </div>
            
            <div class="space-y-5">
                <!-- Mood Selection -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">How are you feeling?</label>
                    
                    <!-- Primary Mood -->
                    <div class="mb-4">
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Primary mood (required)</p>
                        <MoodSelector SelectedMood="@PrimaryMood" OnMoodSelected="OnPrimaryMoodSelected" />
                    </div>
                    
                    <!-- Secondary Moods -->
                    <div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Additional moods (optional, up to 2)</p>
                        <div class="flex flex-wrap gap-2">
                            @foreach (MoodType mood in Enum.GetValues<MoodType>())
                            {
                                @if (mood != PrimaryMood)
                                {
                                    var isSelected = SecondaryMoods.Contains(mood);
                                    var category = mood.GetCategory();
                                    var bgColor = category switch
                                    {
                                        MoodCategory.Positive => isSelected ? "bg-emerald-100 dark:bg-emerald-900/40 border-emerald-300 dark:border-emerald-700" : "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700",
                                        MoodCategory.Neutral => isSelected ? "bg-amber-100 dark:bg-amber-900/40 border-amber-300 dark:border-amber-700" : "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700",
                                        _ => isSelected ? "bg-rose-100 dark:bg-rose-900/40 border-rose-300 dark:border-rose-700" : "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700"
                                    };
                                    
                                    <button @onclick="() => ToggleSecondaryMood(mood)" 
                                            disabled="@(SecondaryMoods.Count >= 2 && !isSelected)"
                                            class="@bgColor px-3 py-1.5 rounded-full border text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:scale-105">
                                        <span>@mood.GetEmoji() @mood</span>
                                    </button>
                                }
                            }
                        </div>
                    </div>
                </div>

                <!-- Tags -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">Tags</label>
                    <TagSelector AvailableTags="@AvailableTags" SelectedTagIds="@SelectedTagIds" OnTagsChanged="OnTagsChanged" />
                </div>

                <!-- Title -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Title</label>
                    <input type="text" @bind="EntryTitle" @bind:event="oninput" placeholder="Give your entry a title..."
                           class="w-full px-4 py-2.5 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-slate-800 dark:text-slate-100 placeholder-slate-400" />
                </div>

                <!-- Content with Rich Text Editor -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">
                            Content
                        </label>
                        @if (LastSavedAt.HasValue)
                        {
                            <span class="text-xs text-slate-400 flex items-center gap-1">
                                @if (IsSaving)
                                {
                                    <span class="animate-pulse">Saving...</span>
                                }
                                else if (HasUnsavedChanges)
                                {
                                    <span class="text-amber-500">● Unsaved changes</span>
                                }
                                else
                                {
                                    <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                                    </svg>
                                    <span>Last saved @LastSavedAt.Value.ToString("h:mm tt")</span>
                                }
                            </span>
                        }
                    </div>
                    
                    
                    <!-- Rich Text Editor -->
                    <div class="border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden">
                        <!-- Toolbar -->
                        <div class="flex flex-wrap items-center gap-1 p-2 bg-slate-100 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
                            <button type="button" @onclick="@(() => ApplyFormat("bold"))" title="Bold (Ctrl+B)" 
                                    class="p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 transition-colors @(IsBold ? "bg-slate-200 dark:bg-slate-700" : "")">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 4h8a4 4 0 014 4 4 4 0 01-4 4H6V4zm0 8h9a4 4 0 014 4 4 4 0 01-4 4H6v-8z"/>
                                </svg>
                            </button>
                            <button type="button" @onclick="@(() => ApplyFormat("italic"))" title="Italic (Ctrl+I)"
                                    class="p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 transition-colors @(IsItalic ? "bg-slate-200 dark:bg-slate-700" : "")">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 4h4m-2 0v16m4-16h-4m-4 16h8"/>
                                </svg>
                            </button>
                            <button type="button" @onclick="@(() => ApplyFormat("underline"))" title="Underline (Ctrl+U)"
                                    class="p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 transition-colors @(IsUnderline ? "bg-slate-200 dark:bg-slate-700" : "")">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 4v7a5 5 0 0010 0V4M5 21h14"/>
                                </svg>
                            </button>
                            <button type="button" @onclick="@(() => ApplyFormat("strikeThrough"))" title="Strikethrough"
                                    class="p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.5 10H19m-14 0h1.5m12 0a5 5 0 00-9-3m0 6a5 5 0 009-3M3 14h18"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Editable Content Area -->
                        <div @ref="EditorRef" 
                             contenteditable="true"
                             @oninput="OnEditorInput"
                             @onkeydown="OnEditorKeyDown"
                             class="min-h-[250px] p-4 bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 focus:outline-none font-serif leading-relaxed"
                             style="white-space: pre-wrap;">
                            @((MarkupString)EditorHtml)
                        </div>
                    </div>
                    <p class="mt-1.5 text-xs text-slate-400">@WordCount words</p>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-between pt-4 border-t border-slate-200 dark:border-slate-700">
                    <button @onclick="CancelEditing" class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                        Cancel
                    </button>
                    <div class="flex gap-3">
                        @if (CurrentEntry != null)
                        {
                            <button @onclick="DeleteEntry" class="px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition-colors">
                                Delete
                            </button>
                        }
                        <button @onclick="SaveEntry" disabled="@(!CanSave)" 
                                class="px-6 py-2 bg-primary-600 hover:bg-primary-700 disabled:bg-slate-300 dark:disabled:bg-slate-600 text-white rounded-lg transition-all font-medium disabled:cursor-not-allowed btn-press ripple">
                            Save Entry
                        </button>
                    </div>
                </div>
            </div>
        </div>
}
</div>

<!-- View Entry Modal -->
@if (ShowViewModal && SelectedEntry != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm modal-backdrop" @onclick="CloseViewModal">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden m-4 modal-content" @onclick:stopPropagation>
            <!-- Header -->
            <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100">@SelectedEntry.Title</h2>
                    <p class="text-sm text-slate-500 mt-1">@SelectedEntry.EntryDate.ToString("dddd, MMMM d, yyyy") at @SelectedEntry.CreatedAt.ToString("h:mm tt")</p>
                </div>
                <button @onclick="CloseViewModal" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Content -->
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <!-- Moods Section -->
                <div class="mb-6">
                    <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Moods</p>
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="flex items-center gap-2 px-3 py-1.5 bg-primary-50 dark:bg-primary-900/30 rounded-full">
                            <span class="text-xl">@SelectedEntry.PrimaryMood.GetEmoji()</span>
                            <span class="text-sm text-primary-700 dark:text-primary-300 font-medium">@SelectedEntry.PrimaryMood</span>
                        </div>
                        @if (SelectedEntry.SecondaryMood1.HasValue)
                        {
                            <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-full">
                                <span class="text-lg">@SelectedEntry.SecondaryMood1.Value.GetEmoji()</span>
                                <span class="text-sm text-slate-600 dark:text-slate-300">@SelectedEntry.SecondaryMood1.Value</span>
                            </div>
                        }
                        @if (SelectedEntry.SecondaryMood2.HasValue)
                        {
                            <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-full">
                                <span class="text-lg">@SelectedEntry.SecondaryMood2.Value.GetEmoji()</span>
                                <span class="text-sm text-slate-600 dark:text-slate-300">@SelectedEntry.SecondaryMood2.Value</span>
                            </div>
                        }
                    </div>
                </div>
                
                <!-- Tags Section -->
                @if (SelectedEntry.Tags?.Any() == true)
                {
                    <div class="mb-6">
                        <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Tags</p>
                        <div class="flex flex-wrap gap-2">
                            @foreach (var tag in SelectedEntry.Tags)
                            {
                                <span class="px-3 py-1 text-sm rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300">
                                    @tag.Name
                                </span>
                            }
                        </div>
                    </div>
                }
                
                <!-- Content Section -->
                <div class="mb-6">
                    <p class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Content</p>
                    <div class="prose prose-slate dark:prose-invert max-w-none">
                        @((MarkupString)SelectedEntry.Content)
                    </div>
                </div>
                
                <!-- Meta Information -->
                <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-slate-400 dark:text-slate-500">Word Count</p>
                            <p class="text-slate-700 dark:text-slate-300 font-medium">@SelectedEntry.WordCount words</p>
                        </div>
                        <div>
                            <p class="text-slate-400 dark:text-slate-500">Last Updated</p>
                            <p class="text-slate-700 dark:text-slate-300 font-medium">@SelectedEntry.UpdatedAt.ToString("MMM d, yyyy h:mm tt")</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer Actions -->
            <div class="flex items-center justify-center p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                <button @onclick="CloseViewModal" class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (ShowDeleteConfirm && EntryToDelete != null)
{
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm modal-backdrop" @onclick="() => ShowDeleteConfirm = false">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm p-6 m-4 modal-content" @onclick:stopPropagation>
            <div class="text-center">
                <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4 animate-wiggle">
                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-2">Delete Entry?</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">This action cannot be undone.</p>
                <div class="flex gap-3">
                    <button @onclick="() => ShowDeleteConfirm = false" class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-all btn-press">
                        Cancel
                    </button>
                    <button @onclick="DeleteEntry" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all btn-press">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
}




@code {
// Query parameters
[SupplyParameterFromQuery(Name = "edit")]
public int? EditEntryId { get; set; }
    
[SupplyParameterFromQuery(Name = "new")]
public bool? NewEntry { get; set; }
    
[SupplyParameterFromQuery(Name = "date")]
public string? EntryDateStr { get; set; }
    
// Multiple entries support
private List<JournalEntry> TodayEntries { get; set; } = new();
private JournalEntry? CurrentEntry { get; set; } // Entry being edited
    private JournalEntry? SelectedEntry { get; set; } // Entry being viewed
    private JournalEntry? EntryToDelete { get; set; } // Entry to be deleted
    
    private StreakInfo StreakInfo { get; set; } = new();
    private List<Tag> AvailableTags { get; set; } = new();
        
    private bool IsLoading { get; set; } = true;
    private bool IsEditing { get; set; }
    private bool ShowViewModal { get; set; }
    private bool ShowDeleteConfirm { get; set; }
        
    // Daily Motivation
    private bool ShowDailyMotivation { get; set; } = true;
    private string DailyQuote { get; set; } = "";
        
    private string EntryTitle { get; set; } = "";
    private string EntryContent { get; set; } = "";
    private MoodType PrimaryMood { get; set; } = MoodType.Calm;
    private List<MoodType> SecondaryMoods { get; set; } = new();
    private List<int> SelectedTagIds { get; set; } = new();

    // Rich text editor state
    private ElementReference EditorRef;
    private string EditorHtml { get; set; } = "";
    private bool IsBold { get; set; }
    private bool IsItalic { get; set; }
    private bool IsUnderline { get; set; }

    // Autosave state
    private DateTime? LastSavedAt { get; set; }
    private bool IsSaving { get; set; }
    private bool HasUnsavedChanges { get; set; }
    private System.Threading.Timer? AutoSaveTimer;
    private string LastSavedContent { get; set; } = "";

    private int WordCount => string.IsNullOrWhiteSpace(EntryContent) 
            ? 0 
            : System.Text.RegularExpressions.Regex.Replace(EntryContent, "<[^>]+>", " ")
                .Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;

    private bool CanSave => !string.IsNullOrWhiteSpace(EntryTitle) && !string.IsNullOrWhiteSpace(EntryContent);
    
    // Date for new entry from calendar
    private DateOnly NewEntryDate { get; set; } = DateOnly.FromDateTime(DateTime.Today);

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
        await LoadMotivationSettings();
        await HandleQueryParameters();
    }

    private async Task HandleQueryParameters()
    {
        // Handle edit parameter
        if (EditEntryId.HasValue)
        {
            var entry = await JournalService.GetEntryByIdAsync(EditEntryId.Value);
            if (entry != null)
            {
                EditEntry(entry);
            }
            // Clear the URL parameters
            NavigationManager.NavigateTo("/", replace: true);
        }
        // Handle new entry parameter
        else if (NewEntry == true)
        {
            if (!string.IsNullOrEmpty(EntryDateStr) && DateOnly.TryParse(EntryDateStr, out var date))
            {
                NewEntryDate = date;
            }
            StartNewEntry();
            // Clear the URL parameters
            NavigationManager.NavigateTo("/", replace: true);
        }
    }

    private async Task LoadMotivationSettings()
    {
        var settings = await SecurityService.GetSettingsAsync();
        ShowDailyMotivation = settings.ShowDailyMotivation;
        DailyQuote = MotivationService.GetDailyQuote();
    }


    private async Task LoadDataAsync()
    {
        IsLoading = true;
        
        var today = DateOnly.FromDateTime(DateTime.Today);
        TodayEntries = await JournalService.GetEntriesByDateAsync(today);
        StreakInfo = await AnalyticsService.GetStreakInfoAsync();
        AvailableTags = await TagService.GetAllTagsAsync();
        
        IsLoading = false;
    }

    private void StartNewEntry()
    {
        CurrentEntry = null;
        ClearForm();
        LastSavedAt = null;
        HasUnsavedChanges = false;
        IsEditing = true;
        EditorHtml = "";
        StartAutoSaveTimer();
    }

    private void EditEntry(JournalEntry entry)
    {
        CurrentEntry = entry;
        EntryTitle = entry.Title;
        EntryContent = entry.Content;
        EditorHtml = entry.Content;
        PrimaryMood = entry.PrimaryMood;
        SecondaryMoods = new List<MoodType>();
        if (entry.SecondaryMood1.HasValue) SecondaryMoods.Add(entry.SecondaryMood1.Value);
        if (entry.SecondaryMood2.HasValue) SecondaryMoods.Add(entry.SecondaryMood2.Value);
        SelectedTagIds = entry.Tags.Select(t => t.Id).ToList();
        LastSavedAt = entry.UpdatedAt;
        LastSavedContent = entry.Content;
        
        HasUnsavedChanges = false;
        IsEditing = true;
        StartAutoSaveTimer();
    }

    private async Task ApplyFormat(string command)
    {
        await JSRuntime.InvokeVoidAsync("document.execCommand", command, false, null);
        await UpdateEditorContent();
    }

    private async Task OnEditorInput(ChangeEventArgs e)
    {
        await UpdateEditorContent();
        HasUnsavedChanges = true;
    }

    private async Task OnEditorKeyDown(KeyboardEventArgs e)
    {
        // Handle Ctrl+B, Ctrl+I, Ctrl+U shortcuts
        if (e.CtrlKey)
        {
            switch (e.Key.ToLower())
            {
                case "b":
                    await ApplyFormat("bold");
                    break;
                case "i":
                    await ApplyFormat("italic");
                    break;
                case "u":
                    await ApplyFormat("underline");
                    break;
            }
        }
    }

    private async Task UpdateEditorContent()
    {
        try
        {
            EntryContent = await JSRuntime.InvokeAsync<string>("eval", "document.querySelector('[contenteditable]')?.innerHTML ?? ''");
            IsBold = await JSRuntime.InvokeAsync<bool>("document.queryCommandState", "bold");
            IsItalic = await JSRuntime.InvokeAsync<bool>("document.queryCommandState", "italic");
            IsUnderline = await JSRuntime.InvokeAsync<bool>("document.queryCommandState", "underline");
        }
        catch
        {
            // Ignore JS errors
        }
    }

    private void InsertFormatting(string prefix, string suffix)
    {
        // Insert formatting at cursor position or wrap selected text
        if (string.IsNullOrEmpty(EntryContent))
        {
            EntryContent = prefix + suffix;
        }
        else
        {
            EntryContent += prefix + suffix;
        }
        HasUnsavedChanges = true;
    }

    private void StopAutoSaveTimer()
    {
        AutoSaveTimer?.Dispose();
        AutoSaveTimer = null;
    }

    private void StartAutoSaveTimer()
    {
        StopAutoSaveTimer();
        AutoSaveTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (HasUnsavedChanges && CanSave && !IsSaving)
                {
                    await AutoSave();
                }
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void OnContentChanged()
    {
        HasUnsavedChanges = EntryContent != LastSavedContent;
    }

    private async Task AutoSave()
    {
        if (!CanSave || IsSaving) return;
        
        IsSaving = true;
        StateHasChanged();

        try
        {
            var tags = await TagService.GetTagsByIdsAsync(SelectedTagIds);

            if (CurrentEntry != null)
            {
                CurrentEntry.Title = EntryTitle;
                CurrentEntry.Content = EntryContent;
                CurrentEntry.PrimaryMood = PrimaryMood;
                CurrentEntry.SecondaryMood1 = SecondaryMoods.Count > 0 ? SecondaryMoods[0] : null;
                CurrentEntry.SecondaryMood2 = SecondaryMoods.Count > 1 ? SecondaryMoods[1] : null;
                CurrentEntry.Tags = tags;
                
                await JournalService.UpdateEntryAsync(CurrentEntry);
            }
            else
            {
                var newEntry = new JournalEntry
                {
                    Title = EntryTitle,
                    Content = EntryContent,
                    EntryDate = DateOnly.FromDateTime(DateTime.Today),
                    PrimaryMood = PrimaryMood,
                    SecondaryMood1 = SecondaryMoods.Count > 0 ? SecondaryMoods[0] : null,
                    SecondaryMood2 = SecondaryMoods.Count > 1 ? SecondaryMoods[1] : null,
                    Tags = tags
                };
                
                CurrentEntry = await JournalService.CreateEntryAsync(newEntry);
            }

            LastSavedAt = DateTime.Now;
            LastSavedContent = EntryContent;
            HasUnsavedChanges = false;
        }
        finally
        {
            IsSaving = false;
            StateHasChanged();
        }
    }

    private void CancelEditing()
    {
        StopAutoSaveTimer();
        IsEditing = false;
        CurrentEntry = null;
        ClearForm();
        HasUnsavedChanges = false;
    }

    private void OnPrimaryMoodSelected(MoodType mood)
    {
        PrimaryMood = mood;
        SecondaryMoods.Remove(mood);
        HasUnsavedChanges = true;
    }

    private void ToggleSecondaryMood(MoodType mood)
    {
        if (SecondaryMoods.Contains(mood))
        {
            SecondaryMoods.Remove(mood);
        }
        else if (SecondaryMoods.Count < 2)
        {
            SecondaryMoods.Add(mood);
        }
        HasUnsavedChanges = true;
    }

    private void OnTagsChanged(List<int> tagIds)
    {
        SelectedTagIds = tagIds;
        HasUnsavedChanges = true;
    }


    private async Task SaveEntry()
    {
        if (!CanSave) return;
        
        IsSaving = true;

        var tags = await TagService.GetTagsByIdsAsync(SelectedTagIds);

        if (CurrentEntry != null)
        {
            CurrentEntry.Title = EntryTitle;
            CurrentEntry.Content = EntryContent;
            CurrentEntry.PrimaryMood = PrimaryMood;
            CurrentEntry.SecondaryMood1 = SecondaryMoods.Count > 0 ? SecondaryMoods[0] : null;
            CurrentEntry.SecondaryMood2 = SecondaryMoods.Count > 1 ? SecondaryMoods[1] : null;
            CurrentEntry.Tags = tags;
            
            await JournalService.UpdateEntryAsync(CurrentEntry);
        }
        else
        {
            var newEntry = new JournalEntry
            {
                Title = EntryTitle,
                Content = EntryContent,
                EntryDate = NewEntryDate,
                PrimaryMood = PrimaryMood,
                SecondaryMood1 = SecondaryMoods.Count > 0 ? SecondaryMoods[0] : null,
                SecondaryMood2 = SecondaryMoods.Count > 1 ? SecondaryMoods[1] : null,
                Tags = tags
            };
            
            await JournalService.CreateEntryAsync(newEntry);
        }

        // Clear form after save
        ClearForm();
        CurrentEntry = null;
        NewEntryDate = DateOnly.FromDateTime(DateTime.Today); // Reset to today
        
        LastSavedAt = DateTime.Now;
        HasUnsavedChanges = false;
        IsSaving = false;
        
        // Reload today's entries
        var today = DateOnly.FromDateTime(DateTime.Today);
        TodayEntries = await JournalService.GetEntriesByDateAsync(today);
        StreakInfo = await AnalyticsService.GetStreakInfoAsync();
        
        StopAutoSaveTimer();
        IsEditing = false;
    }

    private void ClearForm()
    {
        EntryTitle = "";
        EntryContent = "";
        EditorHtml = "";
        PrimaryMood = MoodType.Calm;
        SecondaryMoods = new List<MoodType>();
        SelectedTagIds = new List<int>();
        LastSavedContent = "";
        IsBold = false;
        IsItalic = false;
        IsUnderline = false;
    }

    private void ViewEntry(JournalEntry entry)
    {
        SelectedEntry = entry;
        ShowViewModal = true;
    }

    private void CloseViewModal()
    {
        ShowViewModal = false;
        SelectedEntry = null;
    }

    private void ConfirmDeleteEntry(JournalEntry entry)
    {
        EntryToDelete = entry;
        ShowDeleteConfirm = true;
    }

    private async Task ToggleFavoriteEntry(JournalEntry entry)
    {
        entry.IsFavorite = !entry.IsFavorite;
        await JournalService.UpdateEntryAsync(entry);
    }

    private async Task DeleteEntry()
    {
        if (EntryToDelete != null)
        {
            await JournalService.DeleteEntryAsync(EntryToDelete.Id);
            TodayEntries.Remove(EntryToDelete);
            EntryToDelete = null;
            StreakInfo = await AnalyticsService.GetStreakInfoAsync();
            ShowDeleteConfirm = false;
        }
        
        // Also handle if deleting from edit mode
        if (CurrentEntry != null && IsEditing)
        {
            await JournalService.DeleteEntryAsync(CurrentEntry.Id);
            CurrentEntry = null;
            ClearForm();
            var today = DateOnly.FromDateTime(DateTime.Today);
            TodayEntries = await JournalService.GetEntriesByDateAsync(today);
            StreakInfo = await AnalyticsService.GetStreakInfoAsync();
            StopAutoSaveTimer();
            IsEditing = false;
            ShowDeleteConfirm = false;
        }
    }

    public void Dispose()
    {
        StopAutoSaveTimer();
    }

    private string GetPreviewText(string content)
    {
        if (string.IsNullOrEmpty(content)) return "";
        
        // Strip HTML tags for preview but keep basic text
        var text = System.Text.RegularExpressions.Regex.Replace(content, "<[^>]+>", " ");
        text = System.Net.WebUtility.HtmlDecode(text);
        text = System.Text.RegularExpressions.Regex.Replace(text, @"\s+", " ").Trim();
        
        // Limit to 150 characters
        if (text.Length > 150)
        {
            text = text.Substring(0, 150) + "...";
        }
        
        return System.Net.WebUtility.HtmlEncode(text);
    }
}