@using whitespc.Models

<div class="space-y-3">
    <!-- Search/Add Tag -->
    <div class="relative">
        <input type="text" @bind="SearchTerm" @bind:event="oninput" placeholder="Search or add tag..."
               class="w-full px-4 py-2 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all text-slate-800 dark:text-slate-100 placeholder-slate-400 text-sm" />
        
        @if (!string.IsNullOrWhiteSpace(SearchTerm) && !FilteredTags.Any(t => t.Name.Equals(SearchTerm, StringComparison.OrdinalIgnoreCase)))
        {
            <button @onclick="CreateNewTag" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 bg-primary-600 hover:bg-primary-700 text-white text-xs rounded transition-colors">
                + Add
            </button>
        }
    </div>
    
    <!-- Selected Tags -->
    @if (SelectedTagIds.Any())
    {
        <div class="flex flex-wrap gap-2">
            @foreach (var tagId in SelectedTagIds)
            {
                var tag = AvailableTags.FirstOrDefault(t => t.Id == tagId);
                if (tag != null)
                {
                    <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-primary-100 dark:bg-primary-900/40 text-primary-700 dark:text-primary-300 rounded-full text-sm">
                        @tag.Name
                        <button @onclick="() => RemoveTag(tagId)" class="hover:text-primary-900 dark:hover:text-primary-100">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </span>
                }
            }
        </div>
    }
    
    <!-- Available Tags -->
    <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
        @foreach (var tag in FilteredTags.Where(t => !SelectedTagIds.Contains(t.Id)).Take(20))
        {
            <button @onclick="() => AddTag(tag.Id)" 
                    class="px-3 py-1 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-full text-sm transition-colors">
                @tag.Name
            </button>
        }
    </div>
</div>

@code {
    [Parameter] public List<Tag> AvailableTags { get; set; } = new();
    [Parameter] public List<int> SelectedTagIds { get; set; } = new();
    [Parameter] public EventCallback<List<int>> OnTagsChanged { get; set; }

    private string SearchTerm { get; set; } = "";

    private IEnumerable<Tag> FilteredTags => string.IsNullOrWhiteSpace(SearchTerm)
        ? AvailableTags
        : AvailableTags.Where(t => t.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase));

    private async Task AddTag(int tagId)
    {
        if (!SelectedTagIds.Contains(tagId))
        {
            var newList = new List<int>(SelectedTagIds) { tagId };
            await OnTagsChanged.InvokeAsync(newList);
        }
    }

    private async Task RemoveTag(int tagId)
    {
        var newList = new List<int>(SelectedTagIds);
        newList.Remove(tagId);
        await OnTagsChanged.InvokeAsync(newList);
    }

    private async Task CreateNewTag()
    {
        // This would typically call TagService.CreateTagAsync
        // For now, we'll just clear the search
        SearchTerm = "";
    }
}
