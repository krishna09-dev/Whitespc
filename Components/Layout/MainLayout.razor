@inherits LayoutComponentBase
@implements IDisposable
@inject ThemeService ThemeService
@inject SecurityService SecurityService
@inject NavigationManager NavigationManager

@if (ShowOnboarding)
{
    <Onboarding OnComplete="OnOnboardingComplete" />
}
else if (ShowLockScreen)
{
    <LockScreen OnUnlocked="OnUnlocked" />
}
else
{
    <div class="flex h-screen bg-slate-50 dark:bg-slate-900">
        <!-- Sidebar -->
        <aside class="@(SidebarCollapsed ? "w-16" : "w-64") transition-all duration-300 ease-in-out bg-white dark:bg-slate-800 border-r border-slate-200 dark:border-slate-700 flex flex-col">
            <NavMenu Collapsed="@SidebarCollapsed" OnToggle="ToggleSidebar" />
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header -->
            <header class="h-16 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6">
                <div class="flex items-center gap-4">
                    <button @onclick="ToggleSidebar" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-800 dark:text-slate-100">@GetPageTitle()</h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400">@DateTime.Today.ToString("dddd, MMMM d, yyyy")</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Theme Toggle -->
                    <button @onclick="ToggleTheme" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors" title="@(ThemeService.IsDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode")">
                        @if (ThemeService.IsDarkMode)
                        {
                            <!-- Show Sun icon in dark mode (click to go to light) -->
                            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                        }
                        else
                        {
                            <!-- Show Moon icon in light mode (click to go to dark) -->
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                            </svg>
                        }
                    </button>
                    
                    <!-- Lock Button -->
                    @if (HasPin)
                    {
                        <button @onclick="LockApp" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors" title="Lock journal">
                            <svg class="w-5 h-5 text-slate-600 dark:text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                        </button>
                    }
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-auto p-6 bg-slate-50 dark:bg-slate-900" @onmousemove="UpdateActivity" @onkeydown="UpdateActivity">
                <article class="max-w-6xl mx-auto animate-fade-in">
                    @Body
                </article>
            </main>
        </div>
    </div>
}

@code {
    private bool SidebarCollapsed { get; set; } = false;
    private bool HasPin { get; set; } = false;
    private bool ShowOnboarding { get; set; } = false;
    private bool ShowLockScreen { get; set; } = false;
    private System.Threading.Timer? ActivityTimer;
    private DateTime LastActivityUpdate = DateTime.Now;
    private bool IsInitialized = false;


    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check onboarding status first
            ShowOnboarding = !await SecurityService.HasCompletedOnboardingAsync();
            
            if (!ShowOnboarding)
            {
                var isDarkMode = await SecurityService.GetDarkModeAsync();
                await ThemeService.InitializeAsync(isDarkMode);
                HasPin = await SecurityService.HasPinSetAsync();
                
                // Always show lock screen on app start if PIN is set
                if (HasPin)
                {
                    ShowLockScreen = true;
                    SecurityService.Lock(); // Ensure locked state
                }
                else
                {
                    ShowLockScreen = false;
                }
            }
            
            ThemeService.OnThemeChanged += StateHasChanged;
            SecurityService.OnLockStateChanged += OnLockStateChanged;
            
            // Start activity check timer only if not in onboarding
            if (!ShowOnboarding)
            {
                StartActivityTimer();
            }
            
            IsInitialized = true;
        }
        catch (Exception ex)
        {
            // Log error and show onboarding as fallback
            System.Diagnostics.Debug.WriteLine($"Initialization error: {ex.Message}");
            ShowOnboarding = true;
            IsInitialized = true;
        }
    }

    private void StartActivityTimer()
    {
        ActivityTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                if (!ShowOnboarding && !ShowLockScreen && HasPin)
                {
                    var shouldLock = await SecurityService.ShouldAutoLockAsync();
                    if (shouldLock)
                    {
                        ShowLockScreen = true;
                        StateHasChanged();
                    }
                }
            });
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private async Task UpdateActivity()
    {
        // Throttle updates to once per 10 seconds
        if ((DateTime.Now - LastActivityUpdate).TotalSeconds > 10)
        {
            LastActivityUpdate = DateTime.Now;
            await SecurityService.UpdateActivityAsync();
        }
    }

    private void OnLockStateChanged()
    {
        InvokeAsync(() =>
        {
            ShowLockScreen = !SecurityService.IsUnlocked && HasPin;
            StateHasChanged();
        });
    }

    private async Task OnOnboardingComplete()
    {
        ShowOnboarding = false;
        var isDarkMode = await SecurityService.GetDarkModeAsync();
        await ThemeService.InitializeAsync(isDarkMode);
        HasPin = await SecurityService.HasPinSetAsync();
        ShowLockScreen = false;
        StateHasChanged();
    }

    private void OnUnlocked()
    {
        ShowLockScreen = false;
        StateHasChanged();
    }

    private void ToggleSidebar()
    {
        SidebarCollapsed = !SidebarCollapsed;
    }

    private async Task ToggleTheme()
    {
        await ThemeService.ToggleThemeAsync();
        await SecurityService.SetDarkModeAsync(ThemeService.IsDarkMode);
    }

    private void LockApp()
    {
        SecurityService.Lock();
        ShowLockScreen = true;
    }

    private string GetPageTitle()
    {
        var uri = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        return uri switch
        {
            "" => "Today",
            "calendar" => "Calendar",
            "entries" => "All Entries",
            "analytics" => "Analytics",
            "settings" => "Settings",
            _ => "Journal"
        };
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= StateHasChanged;
        SecurityService.OnLockStateChanged -= OnLockStateChanged;
        ActivityTimer?.Dispose();
    }
}
